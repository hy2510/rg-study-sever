import{a as h,j as l}from"./react-D1It5uYK.js";import{F as E,t as j,f as b}from"./@ffmpeg-BNPV9oVR.js";const y=n=>{const[s,p]=n.split(":");return parseFloat(s)*60+parseFloat(p)},M=n=>{const s=Math.floor(n/3600),p=Math.floor(n%3600/60),e=n%60;return[s.toString().padStart(2,"0"),p.toString().padStart(2,"0"),e.toString().padStart(2,"0")].join(":")},U="https://unpkg.com/@ffmpeg/core@0.12.10/dist/esm";function S(){const[n,s]=h.useState(""),e=h.useRef(new E).current,t=async()=>{await e.load({coreURL:await j(`${U}/ffmpeg-core.js`,"text/javascript"),wasmURL:await j(`${U}/ffmpeg-core.wasm`,"application/wasm")})},g=async(r,o,i)=>{try{if(await t(),e.loaded){let c=[];await e.writeFile("video.mp4",await b(r));for(let a=0;a<o.length;a++)await v(o[a].file,`userAudio${a+1}.mp3`);await e.exec(["-i","video.mp4","-q:a","0","-map","a","audio.mp3"]);for(let a=0;a<i.length;a++){const F=a===0?"00:00":i[a-1].end,T=i[a].start;await x(F,T,`part${a+1}.mp3`),c.push(`part${a+1}.mp3`),c.push(`userAudio${a+1}.mp3`)}await u([...c]),await w("user.mp4");const m=await e.readFile("user.mp4"),d=new Blob([m.buffer],{type:"video/mp4"}),f=URL.createObjectURL(d);s(f),await e.deleteFile("video.mp4"),await e.deleteFile("merged.mp3"),await e.deleteFile("audio.mp3"),await e.deleteFile("user.mp4");for(let a=0;a<i.length;a++)await e.deleteFile(`part${a+1}.mp3`),await e.deleteFile(`userAudio${a+1}.mp3`)}}catch(c){console.log(c)}finally{e.terminate()}},x=async(r,o,i)=>{const c=y(o)-y(r);await e.exec(["-i","audio.mp3","-ss",r,"-t",M(c),i])},u=async r=>{const o=r.reduce((i,c)=>i+"|"+c);console.log(o),await e.exec(["-i",`concat:${o}`,"-c","copy","merged.mp3"])},w=async r=>{await e.exec(["-i","video.mp4","-i","merged.mp3","-c:v","copy","-map","0:v:0","-map","1:a:0",`${r}`])},v=async(r,o)=>{const i=`input_${Date.now()}${R(r.name)}`;await e.writeFile(i,await b(r)),await e.exec(["-i",i,"-ar","44100","-ac","2","-b:a","128k",o]),await e.deleteFile(i)},R=r=>{const o=r.match(/\.[0-9a-z]+$/i);return o?o[0]:".webm"};return{outputFile:n,loadFFmpeg:t,trans:g}}function A(){const[n,s]=h.useState([]);return h.useEffect(()=>{console.log(n)},[n]),{recFiles:n,startRecording:(e,t,g,x)=>{try{(()=>{const w=(y(g)-y(t))*1e3;if(navigator.mediaDevices.getUserMedia){console.log("The mediaDevices.getUserMedia() method is supported.");const v=o=>{const i=new MediaRecorder(o),c=[];i.ondataavailable=m=>{c.push(m.data)},i.onstop=()=>{o.getTracks().forEach(function(F){F.stop()});const m=new Blob(c,{type:i.mimeType}),d=new File([m],`userAudio${e+1}.mp3`,{type:"audio/mp3"});s(F=>[...F.filter(L=>L.index!==e),{index:e,file:d}].sort((L,$)=>L.index-$.index));const f=URL.createObjectURL(m);new Audio(f).play(),setTimeout(()=>{x.current=!1,console.log(x.current)},w)},i.onerror=m=>{alert(m)},i.start(),setTimeout(()=>{i.stop()},w)},R=o=>{console.error("The following error occured: "+o)},r={audio:!0};navigator.mediaDevices.getUserMedia(r).then(v,R).catch(o=>{alert("예기치 못한 오류가 발생했습니다. 리딩게이트로 연락주시길 바랍니다. 1599-0533")})}else alert("MediaDevices.getUserMedia() not supported on your browser!")})()}catch(u){alert(u)}}}}function k({videoRef:n,limit:s,path:p,clearLimit:e}){return h.useEffect(()=>{const t=n.current;if(!t)return;const g=()=>{s.isLimit&&t.currentTime>=s.endTime&&t.pause()},x=()=>{!t.paused&&!t.seeking&&e()};if(t.addEventListener("timeupdate",g),t.addEventListener("play",x),s.isLimit)if(t.readyState>=1)t.currentTime=s.startTime,t.play().catch(u=>{console.warn("자동재생 실패:",u)});else{const u=()=>{t.currentTime=s.startTime,t.play().catch(w=>{console.warn("자동재생 실패:",w)}),t.removeEventListener("loadedmetadata",u)};t.addEventListener("loadedmetadata",u)}return()=>{t.removeEventListener("timeupdate",g),t.removeEventListener("play",x)}},[s,p]),l.jsx("video",{ref:n,src:p,crossOrigin:"anonymous",controls:!0,style:{objectFit:"fill",maxWidth:"500px"}})}function H(){const n=h.useRef(!1),s=h.useRef(null),p="https://wcfresource.a1edu.com/newsystem/aistudio/70100001.mp4",e=[{text:"Hey, guys!",start:"00:00.5",end:"00:02.8"},{text:"Hello! What's your name?",start:"00:04.2",end:"00:07.1"},{text:"My name is Leoni.",start:"00:08.2",end:"00:10.3"}],[t,g]=h.useState({isLimit:!1,startTime:0,endTime:0}),{recFiles:x,startRecording:u}=A(),{outputFile:w,trans:v}=S(),[R,r]=h.useState(0),o=(d,f)=>{g({isLimit:!0,startTime:y(d),endTime:y(f)})},i=(d,f,a)=>{n.current||(n.current=!0,u(d,f,a,n))},c=()=>{v(p,x,e)},m=()=>{g({isLimit:!1,startTime:0,endTime:0})};return l.jsx("div",{style:{display:"flex",width:"100vw",justifyContent:"center",alignItems:"center",color:"white",gap:"5px"},children:l.jsxs("div",{style:{display:"flex",justifyContent:"end",flexDirection:"column",width:"100%",maxWidth:"500px",gap:"5px"},children:[w?l.jsx("video",{src:w,width:500,controls:!0,crossOrigin:"anonymous"}):l.jsx(k,{videoRef:s,limit:t,path:p,clearLimit:m}),l.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"20px",paddingTop:"5px"},children:e.map((d,f)=>l.jsxs("div",{style:{display:"flex",justifyContent:"space-between",marginLeft:"10px",marginRight:"10px"},children:[l.jsx("span",{children:d.text}),l.jsxs("div",{style:{display:"flex",gap:"10px"},children:[l.jsx("div",{style:{border:"1px solid white",paddingRight:"2px",paddingLeft:"2px"},onClick:()=>{o(d.start,d.end)},children:"play"}),l.jsx("div",{style:{border:"1px solid white",paddingRight:"2px",paddingLeft:"2px"},onClick:()=>{i(f,d.start,d.end)},children:"rec"})]})]},f))}),l.jsx("div",{style:{marginTop:"20px",width:"25%",height:"30px",border:"1px solid white",paddingRight:"2px",paddingLeft:"2px",textAlign:"center"},onClick:()=>{c()},children:"trans"})]})})}export{H as default};
